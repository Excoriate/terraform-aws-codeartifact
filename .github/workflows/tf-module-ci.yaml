---
name: ðŸ§© TF Module-Specific CI

on:
  workflow_dispatch:
    inputs:
      module_name:
        description: 'Terraform module name to validate (mandatory)'
        required: true
        type: string
      run_examples_tests:
        description: 'Run examples tests (read-only only)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: read

env:
  TERRAFORM_VERSION: '1.11.2'
  TFLINT_VERSION: 'latest'
  TERRAFORM_DOCS_VERSION: 'latest'
  GO_VERSION: '1.21'
  # AWS mock credentials for read-only tests
  AWS_ACCESS_KEY_ID: 'mock-access-key'
  AWS_SECRET_ACCESS_KEY: 'mock-secret-key'
  AWS_REGION: 'us-east-1'
  # Disable actual AWS operations
  AWS_SDK_LOAD_CONFIG: '0'
  TF_PLUGIN_CACHE_DIR: '${{ github.workspace }}/.terraform.d/plugin-cache'

jobs:
  ci-module:
    name: ðŸŒ Module Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ› ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: ðŸ”§ Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: ðŸ—‚ï¸ Cache TFLint Plugins
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles('modules/${{ inputs.module_name }}/.tflint.hcl') }}

      - name: ðŸ§° Setup Terraform Docs
        run: |
          curl -sSLo ./terraform-docs.tar.gz https://terraform-docs.io/dl/v0.16.0/terraform-docs-v0.16.0-$(uname)-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          sudo mv terraform-docs /usr/local/bin/

      - name: ðŸŒ¿ Module Preparation
        working-directory: modules/${{ inputs.module_name }}
        run: |
          echo "ðŸ” Validating module: ${{ inputs.module_name }}"
          echo "ðŸ“‚ Current directory: $(pwd)"

      - name: ðŸ§¹ Terraform Format Check
        working-directory: modules/${{ inputs.module_name }}
        run: |
          echo "âœ¨ Checking Terraform code formatting..."
          terraform fmt -check -recursive

      - name: ðŸ” TFLint Validation
        working-directory: modules/${{ inputs.module_name }}
        run: |
          echo "ðŸ•µï¸ Running TFLint for module: ${{ inputs.module_name }}"
          tflint --version
          tflint --init
          tflint -f compact
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: ðŸ“„ Terraform Docs Validation
        working-directory: modules/${{ inputs.module_name }}
        run: |
          echo "ðŸ“ Checking required documentation files..."

          # Step 1: Verify README.md exists
          if [ ! -f README.md ]; then
            echo "âŒ Missing README.md file in module: ${{ inputs.module_name }}"
            exit 1
          fi
          echo "âœ… README.md found"

          # Step 2: Verify .terraform-docs.yml exists
          if [ ! -f .terraform-docs.yml ]; then
            echo "âŒ Missing .terraform-docs.yml file in module: ${{ inputs.module_name }}"
            exit 1
          fi
          echo "âœ… .terraform-docs.yml found"

          echo "âœ… All required documentation files are present"

      - name: ðŸ—ï¸ Terraform Initialization
        working-directory: modules/${{ inputs.module_name }}
        run: |
          echo "ðŸš€ Initializing Terraform module..."
          terraform init -backend=false

      - name: ðŸ§ª Terraform Validation
        working-directory: modules/${{ inputs.module_name }}
        run: |
          echo "ðŸ”¬ Validating Terraform module configuration..."
          terraform validate

  discover-test-targets:
    name: ðŸ” Discover Test Targets
    runs-on: ubuntu-latest
    outputs:
      examples: ${{ steps.find-examples.outputs.examples }}
      unit_tests_exist: ${{ steps.check-unit-tests.outputs.exists }}
      examples_tests_exist: ${{ steps.check-examples-tests.outputs.exists }}
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ”Ž Find Example Implementations
        id: find-examples
        run: |
          # Find all directories under the example module directory
          if [ -d "examples/${{ inputs.module_name }}" ]; then
            EXAMPLES=$(find "examples/${{ inputs.module_name }}" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(. != ""))')
            echo "examples=${EXAMPLES}" >> $GITHUB_OUTPUT
            echo "ðŸŒŸ Discovered Examples: ${EXAMPLES}"
          else
            echo "examples=[]" >> $GITHUB_OUTPUT
            echo "âš ï¸ No examples directory found for module: ${{ inputs.module_name }}"
          fi

      - name: ðŸ”Ž Check for Unit Tests
        id: check-unit-tests
        run: |
          UNIT_TEST_DIR="tests/modules/${{ inputs.module_name }}/unit"
          if [ -d "$UNIT_TEST_DIR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ðŸ”¬ Unit Tests Exist: true"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ”¬ Unit Tests Exist: false"
          fi

      - name: ðŸ”Ž Check for Examples Tests
        id: check-examples-tests
        run: |
          EXAMPLES_TEST_DIR="tests/modules/${{ inputs.module_name }}/examples"
          if [ -d "$EXAMPLES_TEST_DIR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ðŸ”¬ Examples Tests Exist: true"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ”¬ Examples Tests Exist: false"
          fi

  ci-examples:
    name: ðŸŒˆ Example Validation - ${{ matrix.example }}
    needs: [ci-module, discover-test-targets]
    runs-on: ubuntu-latest
    if: ${{ needs.discover-test-targets.outputs.examples != '[]' && needs.discover-test-targets.outputs.examples != '' }}
    strategy:
      fail-fast: false
      matrix:
        example: ${{ fromJson(needs.discover-test-targets.outputs.examples) }}
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ› ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: ðŸ§ª Validate Example - ${{ matrix.example }}
        run: |
          echo "ðŸ” Validating example: ${{ matrix.example }}"

          EXAMPLE_PATH="examples/${{ inputs.module_name }}/${{ matrix.example }}"
          echo "ðŸ“‚ Validating directory: ${EXAMPLE_PATH}"

          # Change to example directory
          cd "${EXAMPLE_PATH}"

          # Terraform fmt check
          echo "âœ¨ Checking Terraform formatting..."
          terraform fmt -check -recursive

          # Terraform init
          echo "ðŸš€ Initializing Terraform example..."
          terraform init -backend=false

          # Terraform validate
          echo "ðŸ§ª Validating Terraform configuration..."
          terraform validate

  ci-terratest-unit-readonly:
    name: ðŸ§ª Unit Tests (Readonly)
    needs: [ci-module, discover-test-targets]
    runs-on: ubuntu-latest
    if: ${{ needs.discover-test-targets.outputs.unit_tests_exist == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ› ï¸ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ðŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: ðŸ”§ Create Terraform Plugin Cache Directory
        run: |
          mkdir -p ${{ env.TF_PLUGIN_CACHE_DIR }}

      - name: ðŸ§ª Run Unit Tests (Readonly)
        working-directory: tests
        run: |
          echo "ðŸš€ Running Readonly Unit Tests for module: ${{ inputs.module_name }}"

          # Clean up any existing state before running
          find ../modules/${{ inputs.module_name }} -name ".terraform" -type d -exec rm -rf {} \; 2>/dev/null || true
          find ../modules/${{ inputs.module_name }} -name ".terraform.lock.hcl" -type f -delete 2>/dev/null || true

          # Ensure Go modules are up to date
          go mod tidy

          # Create a mock AWS provider config if needed
          echo "Creating mock AWS provider configuration for readonly tests..."
          cat > aws_mock.go <<EOF
          //go:build readonly

          package helper

          import (
            "os"
          )

          func init() {
            os.Setenv("AWS_ACCESS_KEY_ID", "mock-access-key")
            os.Setenv("AWS_SECRET_ACCESS_KEY", "mock-secret-key")
            os.Setenv("AWS_REGION", "us-east-1")
            os.Setenv("TF_VAR_skip_provider_registration", "true")
          }
          EOF

          # Run the tests with appropriate tags
          # Using -v for verbose output and -count=1 to disable caching
          go test -v -tags 'readonly,unit' -count=1 ./modules/${{ inputs.module_name }}/unit/...

  ci-terratest-examples-readonly:
    name: ðŸ§ª Examples Tests (Readonly)
    needs: [ci-module, discover-test-targets]
    runs-on: ubuntu-latest
    if: ${{ needs.discover-test-targets.outputs.examples_tests_exist == 'true' && inputs.run_examples_tests == true }}
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ› ï¸ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ðŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: ðŸ”§ Create Terraform Plugin Cache Directory
        run: |
          mkdir -p ${{ env.TF_PLUGIN_CACHE_DIR }}

      - name: ðŸ§ª Run Examples Tests (Readonly)
        working-directory: tests
        run: |
          echo "ðŸš€ Running Readonly Examples Tests for module: ${{ inputs.module_name }}"

          # Clean up any existing state before running
          find ../modules/${{ inputs.module_name }} -name ".terraform" -type d -exec rm -rf {} \; 2>/dev/null || true
          find ../modules/${{ inputs.module_name }} -name ".terraform.lock.hcl" -type f -delete 2>/dev/null || true

          # Find all terraform example directories and clean them
          find ../examples/${{ inputs.module_name }} -name ".terraform" -type d -exec rm -rf {} \; 2>/dev/null || true
          find ../examples/${{ inputs.module_name }} -name ".terraform.lock.hcl" -type f -delete 2>/dev/null || true

          # Ensure Go modules are up to date
          go mod tidy

          # Create a mock AWS provider config if needed
          echo "Creating mock AWS provider configuration for readonly tests..."
          cat > aws_mock.go <<EOF
          //go:build readonly

          package helper

          import (
            "os"
          )

          func init() {
            os.Setenv("AWS_ACCESS_KEY_ID", "mock-access-key")
            os.Setenv("AWS_SECRET_ACCESS_KEY", "mock-secret-key")
            os.Setenv("AWS_REGION", "us-east-1")
            os.Setenv("TF_VAR_skip_provider_registration", "true")
          }
          EOF

          # Create mock provider override for terraform
          mkdir -p ./mocks
          cat > ./mocks/provider_override.tf <<EOF
          provider "aws" {
            region                      = "us-east-1"
            access_key                  = "mock-access-key"
            secret_key                  = "mock-secret-key"
            skip_credentials_validation = true
            skip_requesting_account_id  = true
            skip_metadata_api_check     = true
          }
          EOF

          # Copy the mock provider to each test directory
          if [ -d "./modules/${{ inputs.module_name }}/examples" ]; then
            find ./modules/${{ inputs.module_name }}/examples -name "*_test.go" -exec dirname {} \; | sort -u | while read dir; do
              cp ./mocks/provider_override.tf "$dir/"
              echo "Added provider override to $dir"
            done
          fi

          # Edit the Terratest helper to include special handling for readonly tests
          if [ -f "./pkg/helper/terraform.go" ]; then
            cat >> ./pkg/helper/terraform.go <<EOF

          // SetupReadonlyTerraformOptions configures Terraform options for read-only tests
          func SetupReadonlyTerraformOptions(t TestingT, examplePath string, vars map[string]interface{}) *terraform.Options {
            opts := SetupTerraformOptions(t, examplePath, vars)
            // Add special flags for readonly tests
            opts.EnvVars["TF_CLI_ARGS"] = "-refresh=false"
            opts.EnvVars["TF_SKIP_PROVIDER_VERIFY"] = "1"
            return opts
          }
          EOF
          fi

          # Run the tests with appropriate tags
          # Using -v for verbose output and -count=1 to disable caching
          go test -v -tags 'readonly,examples' -count=1 ./modules/${{ inputs.module_name }}/examples/...

  summary:
    name: ðŸ Validation Summary
    needs:
      - ci-module
      - ci-examples
      - ci-terratest-unit-readonly
      - ci-terratest-examples-readonly
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š Workflow Status
        run: |
          echo "ðŸš€ Module-Specific Terraform CI Complete!"
          echo "âœ… Module: ${{ inputs.module_name }}"
          echo "ðŸ” Detailed results available in job logs."

          # Check the status of all jobs
          if [[ "${{ needs.ci-module.result }}" != "success" ]]; then
            echo "âŒ Module validation failed"
            exit 1
          fi

          # ci-examples may be skipped if there are no examples
          if [[ "${{ needs.ci-examples.result }}" != "success" && "${{ needs.ci-examples.result }}" != "skipped" ]]; then
            echo "âŒ Examples validation failed"
            exit 1
          fi

          # Unit tests (readonly) may be skipped if there are no unit tests
          if [[ "${{ needs.ci-terratest-unit-readonly.result }}" != "success" && "${{ needs.ci-terratest-unit-readonly.result }}" != "skipped" ]]; then
            echo "âŒ Unit tests (readonly) failed"
            exit 1
          fi

          # Examples tests (readonly) may be skipped if there are no examples tests or not requested
          if [[ "${{ needs.ci-terratest-examples-readonly.result }}" != "success" && "${{ needs.ci-terratest-examples-readonly.result }}" != "skipped" ]]; then
            echo "âŒ Examples tests (readonly) failed"
            exit 1
          fi

          echo "âœ… All checks passed!"
